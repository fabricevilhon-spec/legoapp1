<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGO Simulator - Pro v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            --bg-color: #0f1014;
            --panel-bg: rgba(20, 21, 26, 0.9);
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --text-color: #f3f4f6;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            outline: none;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        #ui-container>* {
            pointer-events: auto;
        }

        header {
            margin-bottom: auto;
        }

        header h1 {
            font-size: 1.8rem;
            color: var(--accent-color);
            font-weight: 600;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            opacity: 0.5;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
        }

        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        button.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            transform: scale(1.02);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .color-btn {
            height: 35px;
            border-width: 2px;
        }

        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--bg-color), 0 0 10px var(--accent-color);
        }

        #action-bar {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        #action-bar button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            font-weight: 600;
        }

        #clear-btn {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        #clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        footer {
            margin-top: auto;
            text-align: center;
            width: 100%;
        }

        footer p {
            font-size: 0.8rem;
            opacity: 0.5;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.3rem 1rem;
            border-radius: 20px;
            display: inline-block;
        }

        #status-bar {
            position: fixed;
            bottom: 3rem;
            right: 1.5rem;
            background: var(--panel-bg);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            z-index: 100;
            pointer-events: none;
        }

        #status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            margin-right: 0.5rem;
        }

        #status-indicator.ready {
            background: #10b981;
            box-shadow: 0 0 8px #10b981;
        }

        .key-hint {
            background: rgba(0, 0, 0, 0.2);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.7rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div id="ui-container">
        <header>
            <h1>LEGO Builder v2</h1>
            <p>Advanced Physics & Undo/Redo Engine</p>
        </header>

        <div class="panel">
            <div>
                <div class="section-title">1. Build Actions</div>
                <div id="action-bar">
                    <button id="undo-btn" title="Undo (Ctrl+Z)">↺ Undo</button>
                    <button id="redo-btn" title="Redo (Ctrl+Y)">↻ Redo</button>
                </div>
                <!-- New Buttons -->
                <button id="cancel-btn"
                    style="width:100%; margin-top:0.5rem; display:none; background:rgba(255,255,255,0.1);">Cancel /
                    Deselect <span class="key-hint">ESC</span></button>
                <button id="delete-btn" style="width:100%; margin-top:0.5rem; display:none;">Delete Selected <span
                        class="key-hint">DEL</span></button>
            </div>

            <div>
                <div class="section-title">2. Select Brick</div>
                <div class="grid-2" id="brick-selector">
                    <button class="active" data-size="2x4">Brick 2x4</button>
                    <button data-size="2x2">Brick 2x2</button>
                    <button data-size="1x2">Brick 1x2</button>
                    <button data-size="1x1">Brick 1x1</button>
                </div>
            </div>

            <div>
                <div class="section-title">3. Color</div>
                <div class="grid-3" id="color-grid">
                    <button class="color-btn active" data-color="#d32f2f" style="background: #d32f2f;"></button>
                    <button class="color-btn" data-color="#1976d2" style="background: #1976d2;"></button>
                    <button class="color-btn" data-color="#388e3c" style="background: #388e3c;"></button>
                    <button class="color-btn" data-color="#fbc02d" style="background: #fbc02d;"></button>
                    <button class="color-btn" data-color="#ffffff" style="background: #ffffff;"></button>
                    <button class="color-btn" data-color="#212121" style="background: #212121;"></button>
                </div>
            </div>

            <button id="clear-btn">Clear Workspace</button>
        </div>

        <footer>
            <p>Drag: Left Click | Orbit: Right Click or ⌘+Drag | Zoom: Scroll | Deselect: Esc</p>
        </footer>
    </div>

    <div id="status-bar">
        <span id="status-indicator"></span>
        <span id="status-text">Booting Engine...</span>
    </div>

    <canvas id="three-canvas"></canvas>

    <script>
        class LegoApp {
            constructor() {
                this.BRICK_H = 1.2;
                this.LDU = 0.4; // 1 stud = 2 LDU gap (standard lego ratio)
                this.history = [];
                this.redoStack = [];
                this.bricks = [];
                this.selectedBrick = null;

                try {
                    this.init();
                    this.setStatus("Engine Ready", true);
                } catch (e) {
                    console.error(e);
                    this.setStatus("Fatal Error: " + e.message, false);
                }
            }

            setStatus(text, ready) {
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                statusText.innerText = text;
                if (ready) indicator.classList.add('ready');
                else indicator.classList.remove('ready');
            }

            init() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0a0a0c);

                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(20, 20, 20);

                this.renderer = new THREE.WebGLRenderer({
                    canvas: document.querySelector('#three-canvas'),
                    antialias: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                // STANDARD CONTROLS: Left = Rotate, Right = Pan
                this.controls.mouseButtons = { LEFT: THREE.MOUSE.ROTATE, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.PAN };

                this.initLights();
                this.initBase();
                this.initUI();
                this.initInteraction();
                this.initGhost();
                this.animate();
            }

            initLights() {
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.4));
                const sun = new THREE.DirectionalLight(0xffffff, 1.0);
                sun.position.set(30, 50, 20);
                sun.castShadow = true;
                sun.shadow.mapSize.width = 2048;
                sun.shadow.mapSize.height = 2048;
                sun.shadow.camera.left = -50;
                sun.shadow.camera.right = 50;
                sun.shadow.camera.top = 50;
                sun.shadow.camera.bottom = -50;
                this.scene.add(sun);

                const fill = new THREE.PointLight(0x3b82f6, 0.6);
                fill.position.set(-20, 10, -20);
                this.scene.add(fill);
            }

            initBase() {
                // REALISTIC LEGO GRID: 1 unit in 3D = 1 stud (approx 8mm)
                const grid = new THREE.GridHelper(80, 80, 0x1e293b, 0x111827);
                grid.position.y = -0.01;
                this.scene.add(grid);

                const geo = new THREE.PlaneGeometry(200, 200);
                const mat = new THREE.ShadowMaterial({ opacity: 0.2 });
                this.basePlane = new THREE.Mesh(geo, mat);
                this.basePlane.rotation.x = -Math.PI / 2;
                this.basePlane.receiveShadow = true;
                this.scene.add(this.basePlane);
            }

            createBrick(w, l, color, options = {}) {
                const group = new THREE.Group();
                const { isGhost = false, isSelected = false } = options;

                // Body
                const bodyGeo = new THREE.BoxGeometry(w, this.BRICK_H, l);
                let mat;
                if (isGhost) {
                    mat = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.5 });
                } else {
                    mat = new THREE.MeshStandardMaterial({
                        color: isSelected ? 0x60a5fa : color,
                        roughness: 0.2,
                        metalness: 0.1,
                        emissive: isSelected ? 0x1d4ed8 : 0x000000,
                        emissiveIntensity: isSelected ? 0.3 : 0
                    });
                }

                const body = new THREE.Mesh(bodyGeo, mat);
                body.position.y = this.BRICK_H / 2;
                body.castShadow = !isGhost;
                body.receiveShadow = !isGhost;
                group.add(body);

                // Studs (Real LEGO alignment)
                const studGeo = new THREE.CylinderGeometry(0.35, 0.35, 0.2, 16);
                for (let x = 0; x < w; x++) {
                    for (let z = 0; z < l; z++) {
                        const stud = new THREE.Mesh(studGeo, mat);
                        // Center of brick is 0,0. Studs are at steps of 1.0
                        stud.position.set(
                            (x - (w - 1) / 2),
                            this.BRICK_H + 0.1,
                            (z - (l - 1) / 2)
                        );
                        stud.castShadow = !isGhost;
                        stud.receiveShadow = !isGhost;
                        group.add(stud);
                    }
                }

                group.userData = { type: 'brick', w, l, color };
                return group;
            }

            initGhost() {
                this.ghost = new THREE.Group();
                this.scene.add(this.ghost);
                this.updateGhost();
            }

            updateGhost() {
                while (this.ghost.children.length > 0) this.ghost.remove(this.ghost.children[0]);
                if (!this.selectedSize) {
                    this.ghost.visible = false;
                    return;
                }
                const [w, l] = this.selectedSize.split('x').map(Number);
                this.ghost.add(this.createBrick(w, l, this.selectedColor, { isGhost: true }));
                this.ghost.visible = true;
            }

            initUI() {
                this.selectedSize = '2x4';
                this.selectedColor = '#d32f2f';

                const brickBtns = document.querySelectorAll('#brick-selector button');
                brickBtns.forEach(btn => btn.onclick = (e) => {
                    e.stopPropagation();
                    brickBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.selectedSize = btn.dataset.size;
                    this.selectedBrick = null; // Deselect any existing brick selection
                    this.updateGhost();
                    document.getElementById('cancel-btn').style.display = 'block';
                    document.getElementById('delete-btn').style.display = 'none';
                });

                const colorBtns = document.querySelectorAll('.color-btn');
                colorBtns.forEach(btn => btn.onclick = (e) => {
                    e.stopPropagation();
                    colorBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.selectedColor = btn.dataset.color;
                    this.updateGhost();
                });

                document.getElementById('undo-btn').onclick = (e) => { e.stopPropagation(); this.undo(); };
                document.getElementById('redo-btn').onclick = (e) => { e.stopPropagation(); this.redo(); };
                document.getElementById('delete-btn').onclick = (e) => { e.stopPropagation(); this.deleteSelected(); };
                document.getElementById('cancel-btn').onclick = (e) => { e.stopPropagation(); this.clearUIStates(); };
                document.getElementById('clear-btn').onclick = (e) => { e.stopPropagation(); this.clearWorkspace(); };

                this.updateHistoryButtons();
            }

            initInteraction() {
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();

                window.addEventListener('mousemove', (e) => {
                    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    this.handleSnap();
                });

                this.renderer.domElement.addEventListener('pointerdown', (e) => {
                    if (e.button === 0) { // Left click
                        // First check if we are clicking an existing brick to select it
                        this.raycaster.setFromCamera(this.mouse, this.camera);
                        const hits = this.raycaster.intersectObjects(this.bricks, true);

                        if (hits.length > 0) {
                            let obj = hits[0].object;
                            while (obj.parent && obj.userData.type !== 'brick') obj = obj.parent;
                            this.selectBrick(obj);
                        } else {
                            if (this.ghost.visible) this.placeBrick();
                            else this.clearUIStates();
                        }
                    }
                });

                window.addEventListener('keydown', (e) => {
                    if (e.key === 'z' && (e.ctrlKey || e.metaKey)) this.undo();
                    if (e.key === 'y' && (e.ctrlKey || e.metaKey)) this.redo();
                    if (e.key === 'Delete' || e.key === 'Backspace') this.deleteSelected();
                    if (e.key === 'Escape') this.clearUIStates();
                });
            }

            handleSnap() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const hits = this.raycaster.intersectObjects([this.basePlane, ...this.bricks], true);

                if (hits.length > 0 && !this.selectedBrick && this.selectedSize) {
                    const hit = hits[0];
                    let x, y, z;

                    if (hit.object === this.basePlane) {
                        // GROUND SNAPPING: Perfect alignment with grid lines
                        const [w, l] = this.selectedSize.split('x').map(Number);

                        // If dimension is even (2, 4), center is on integer (e.g. 0.0)
                        // If dimension is odd (1), center is on half-integer (e.g. 0.5)
                        x = (w % 2 === 0) ? Math.round(hit.point.x) : Math.floor(hit.point.x) + 0.5;
                        z = (l % 2 === 0) ? Math.round(hit.point.z) : Math.floor(hit.point.z) + 0.5;
                        y = 0;
                    } else {
                        // STUD SNAPPING: Align to the studs of the brick below
                        let obj = hit.object;
                        while (obj.parent && obj.userData.type !== 'brick') obj = obj.parent;

                        const [w, l] = this.selectedSize.split('x').map(Number);

                        // Use the same alignment logic relative to the world grid
                        x = (w % 2 === 0) ? Math.round(hit.point.x) : Math.floor(hit.point.x) + 0.5;
                        z = (l % 2 === 0) ? Math.round(hit.point.z) : Math.floor(hit.point.z) + 0.5;
                        y = obj.position.y + this.BRICK_H;
                    }

                    this.ghost.position.set(x, y, z);
                    this.ghost.visible = true;
                } else {
                    this.ghost.visible = false;
                }
            }

            placeBrick() {
                const [w, l] = this.selectedSize.split('x').map(Number);
                const brick = this.createBrick(w, l, this.selectedColor);
                brick.position.copy(this.ghost.position);

                this.addBrickToScene(brick);
                this.pushHistory({ type: 'place', brick });
                this.ghost.visible = false;
            }

            addBrickToScene(brick) {
                this.scene.add(brick);
                this.bricks.push(brick);
            }

            selectBrick(brick) {
                this.deselectBrick();
                this.selectedBrick = brick;
                this.ghost.visible = false;

                // Highlight
                brick.children.forEach(c => {
                    if (c.material) {
                        c.material.emissive.setHex(0x1d4ed8);
                        c.material.emissiveIntensity = 0.5;
                    }
                });

                document.getElementById('delete-btn').style.display = 'block';
            }

            deselectBrick() {
                if (this.selectedBrick) {
                    this.selectedBrick.children.forEach(c => {
                        if (c.material) {
                            c.material.emissive.setHex(0x000000);
                            c.material.emissiveIntensity = 0;
                        }
                    });
                    this.selectedBrick = null;
                }
                document.getElementById('delete-btn').style.display = 'none';
            }

            clearUIStates() {
                this.deselectBrick();
                this.selectedSize = null;
                this.ghost.visible = false;
                document.querySelectorAll('#brick-selector button').forEach(b => b.classList.remove('active'));
                document.getElementById('cancel-btn').style.display = 'none';
            }

            deleteSelected() {
                if (!this.selectedBrick) return;
                const brick = this.selectedBrick;
                this.pushHistory({ type: 'delete', brick });
                this.removeBrickFromScene(brick);
                this.deselectBrick();
            }

            removeBrickFromScene(brick) {
                this.scene.remove(brick);
                this.bricks = this.bricks.filter(b => b !== brick);
            }

            // HISTORY ENGINE
            pushHistory(action) {
                this.history.push(action);
                this.redoStack = [];
                this.updateHistoryButtons();
            }

            undo() {
                if (this.history.length === 0) return;
                const action = this.history.pop();
                this.redoStack.push(action);

                if (action.type === 'place') this.removeBrickFromScene(action.brick);
                if (action.type === 'delete') this.addBrickToScene(action.brick);
                if (action.type === 'clear') action.bricks.forEach(b => this.addBrickToScene(b));

                this.deselectBrick();
                this.updateHistoryButtons();
            }

            redo() {
                if (this.redoStack.length === 0) return;
                const action = this.redoStack.pop();
                this.history.push(action);

                if (action.type === 'place') this.addBrickToScene(action.brick);
                if (action.type === 'delete') this.removeBrickFromScene(action.brick);
                if (action.type === 'clear') action.bricks.forEach(b => this.removeBrickFromScene(b));

                this.updateHistoryButtons();
            }

            clearWorkspace() {
                if (this.bricks.length === 0) return;
                const currentBricks = [...this.bricks];
                this.pushHistory({ type: 'clear', bricks: currentBricks });
                currentBricks.forEach(b => this.removeBrickFromScene(b));
            }

            updateHistoryButtons() {
                document.getElementById('undo-btn').disabled = this.history.length === 0;
                document.getElementById('redo-btn').disabled = this.redoStack.length === 0;
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.controls) this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        }

        window.onload = () => { window.app = new LegoApp(); };
    </script>
</body>

</html>